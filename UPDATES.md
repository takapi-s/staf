# Auto-Update Implementation Guide

This document explains how to use and configure the auto-update feature implemented in the STAF application.

## Overview

The auto-update feature is implemented using the Tauri Updater plugin. Users can easily update to new versions with a simple button click.

## Setup Instructions

### 1. Generate Key Pair

Generate the key pair required for signing updates:

```bash
# Generate keys using Tauri CLI
npx @tauri-apps/cli signer generate -w ~/.tauri/myapp.key
```

This command generates:
- **Private Key**: `~/.tauri/myapp.key` (never share publicly)
- **Public Key**: `pubkey` displayed in terminal (set this in config file)

### 2. Update Configuration File

Configure the public key and endpoint in `src-tauri/tauri.conf.json`:

```json
{
  "plugins": {
    "updater": {
      "active": true,
      "endpoints": [
        "https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/updater.json"
      ],
      "dialog": true,
      "pubkey": "YOUR_PUBLIC_KEY_HERE"
    }
  }
}
```

### 3. Generate Release Bundle

Generate release bundle during build:

```bash
npm run tauri:build
```

The following files will be generated:
- Executable files in `src-tauri/target/release/`
- Bundles in `src-tauri/target/release/bundle/`

### 4. Sign Release Bundle

Sign the generated bundle:

```bash
# For Windows
npx @tauri-apps/cli signer update \
  --key ~/.tauri/myapp.key \
  --updater-url https://example.com/updater.json \
  src-tauri/target/release/bundle/nsis/staf_0.1.0_x64-setup.exe
```

### 5. Create Updater Configuration File

Create `updater.json` in your GitHub repository:

```json
{
  "version": "0.1.0",
  "notes": "Initial release",
  "pub_date": "2024-01-01T00:00:00Z",
  "platforms": {
    "windows-x86_64": {
      "signature": "Update file signature (generated by signing command)",
      "url": "https://github.com/YOUR_USERNAME/YOUR_REPO/releases/download/v0.1.0/staf_0.1.0_x64-setup.exe"
    }
  }
}
```

### 6. Upload to GitHub

1. Create a release on GitHub
2. Upload the signed installer
3. Push `updater.json` to the main branch of your repository

## Usage

### For Developers

#### Steps to Release a New Version

1. **Update Version Numbers**
   ```bash
   # package.json
   "version": "0.1.1"
   
   # src-tauri/Cargo.toml
   version = "0.1.1"
   
   # src-tauri/tauri.conf.json
   "version": "0.1.1"
   ```

2. **Build and Sign**
   ```bash
   npm run tauri:build
   npx @tauri-apps/cli signer update --key ~/.tauri/myapp.key src-tauri/target/release/bundle/nsis/staf_0.1.1_x64-setup.exe
   ```

3. **Update updater.json**
   ```json
   {
     "version": "0.1.1",
     "notes": "Bug fixes and performance improvements",
     "pub_date": "2024-01-15T00:00:00Z",
     "platforms": {
       "windows-x86_64": {
         "signature": "New signature",
         "url": "https://github.com/YOUR_USERNAME/YOUR_REPO/releases/download/v0.1.1/staf_0.1.1_x64-setup.exe"
       }
     }
   }
   ```

4. **Publish Release**
   - Publish version 0.1.1 on GitHub Releases
   - Commit updater.json

### For Users

#### How to Update Within the App

1. **Manual Check**
   - Click the "Check for Updates" button in the header
   - A notification will appear if a new version is available

2. **Auto Update**
   - Click "Update Now" in the dialog
   - Download and installation will run automatically
   - The app will restart automatically after completion

## Troubleshooting

### Unable to Download Updates

**Cause**: Network connection issues
**Solution**: Check internet connection

### Signature Error

**Cause**: Public key mismatch
**Solution**: Verify `pubkey` in configuration file

### App Won't Start After Update

**Cause**: Installation error
**Solution**: 
1. Completely uninstall the app
2. Manually download and reinstall the latest version

## Security Considerations

1. **Private Key Protection**
   - Never share `~/.tauri/myapp.key` publicly
   - Don't add to version control (add to `.gitignore`)
   
   ```gitignore
   # Add to .gitignore
   **/*.key
   ```

2. **Public Key Verification**
   - Users verify signatures with the public key
   - Tampered files cannot be installed

3. **HTTPS Usage**
   - updater.json and download URLs must use HTTPS
   - GitHub Releases is recommended

## Configuration Options

Configurable in the `updater` section of `tauri.conf.json`:

| Option | Description | Default |
|---------|-----|---------|
| `active` | Enable auto-update | `true` |
| `endpoints` | URLs to fetch update information | `[]` |
| `dialog` | Show dialog | `true` |
| `pubkey` | Public key | Required |
| `windows` | Windows-specific settings | `{}` |

## Reference Links

- [Tauri Updater Official Documentation](https://tauri.app/v1/guides/distribution/updater)
- [Signing Details](https://tauri.app/v1/api/cli/#signer)

## Checklist

Before releasing a new version, verify:

- [ ] Update version numbers
- [ ] Build and test
- [ ] Sign bundle
- [ ] Update updater.json
- [ ] Upload to GitHub Releases
- [ ] Commit updater.json
- [ ] Test update on existing installations

